<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å®¶åº­ç®¡å®¶</title>
    <style>
        /* ç®€å•çš„ç°ä»£é£æ ¼ CSS */
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            color: #334155;
        }

        h1 {
            text-align: center;
            color: #1e293b;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            background: #1d4ed8;
        }

        button:disabled {
            background: #94a3b8;
            cursor: wait;
        }

        .result-item {
            border-bottom: 1px solid #e2e8f0;
            padding: 10px 0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-loc {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-qty {
            background: #dcfce7;
            color: #166534;
        }

        #status {
            display: none;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .success {
            background: #dcfce7;
            color: #166534;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* æ ‘çŠ¶ç»“æ„æ ·å¼ */
        ul {
            padding-left: 20px;
        }

        li {
            margin: 5px 0;
        }

        .result-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            /* å¡ç‰‡ä¹‹é—´æ‹‰å¼€è·ç¦» */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }
    </style>
</head>

<body>

    <h1>ğŸ¤– AI å®¶åº­ç®¡å®¶</h1>

    <div class="container">
        <!-- å½•å…¥å¡ç‰‡ -->
        <div class="card">
            <h3>ğŸ“ å‘Šè¯‰ç®¡å®¶</h3>
            <input type="text" id="input-text" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä¹°äº†20ä¸ªå£ç½©æ”¾åœ¨é‹æŸœ">
            <button onclick="addMemory()" id="btn-add">å‘é€æŒ‡ä»¤</button>
            <div id="add-result" style="margin-top: 10px; font-size: 14px; color: #64748b;"></div>
        </div>

        <!-- æœç´¢å¡ç‰‡ -->
        <div class="card">
            <h3>ğŸ” å¯»æ‰¾ç‰©å“</h3>
            <input type="text" id="search-query" placeholder="ä¾‹å¦‚ï¼šæ´—æ¼±ç”¨å“åœ¨å“ª">
            <button onclick="searchMemory()" style="background-color: #0f172a;">å¼€å§‹æœç´¢</button>
            <div id="search-results"></div>
        </div>

        <!-- ä½ç½®æ ‘å¡ç‰‡ -->
        <div class="card">
            <h3>ğŸ  ç©ºé—´æ¦‚è§ˆ</h3>
            <button onclick="loadLocationTree()" style="background-color: #64748b; margin-bottom: 10px;">åˆ·æ–°ä½ç½®æ ‘</button>
            <div id="location-tree"></div>
        </div>
    </div>

    <script>
        // API åœ°å€ (æ³¨æ„ï¼šå¦‚æœæ‚¨çš„å‰ç«¯ä¸æ˜¯é€šè¿‡ Docker è·‘çš„ï¼Œlocalhost æŒ‡å‘æœ¬æœºï¼Œç«¯å£ 8000)
        const API_BASE = 'http://localhost:8000';

        // 1. æ™ºèƒ½å½•å…¥
        async function addMemory() {
            const input = document.getElementById('input-text');
            const btn = document.getElementById('btn-add');
            const resultDiv = document.getElementById('add-result');
            const text = input.value.trim();

            if (!text) return;

            // UI Loading çŠ¶æ€
            btn.disabled = true;
            btn.innerText = "AI æ­£åœ¨åˆ†æ...";
            resultDiv.innerHTML = "";

            try {
                const res = await fetch(`${API_BASE}/memories/auto_add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    // æ˜¾ç¤ºæå–ç»“æœ
                    const info = data.ai_extraction;
                    resultDiv.innerHTML = `
                        <div style="color: green;">âœ… å½•å…¥æˆåŠŸï¼</div>
                        <div>è¯†åˆ«ç‰©å“ï¼š<b>${info.name}</b></div>
                        <div>æ•°é‡ï¼š<span class="badge badge-qty">${info.quantity} ${info.unit}</span></div>
                        <div>ä½ç½®ï¼š<span class="badge badge-loc">${info.location || 'è‡ªåŠ¨å½’ç±»'}</span></div>
                    `;
                    input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    loadLocationTree(); // åˆ·æ–°ä½ç½®æ ‘
                } else {
                    resultDiv.innerHTML = `<div style="color: red;">âŒ ${data.message}</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div style="color: red;">ç½‘ç»œé”™è¯¯: ${err.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "å‘é€æŒ‡ä»¤";
            }
        }

        // 2. æ™ºèƒ½æœç´¢
        // index.html -> script æ ‡ç­¾å†…

        async function searchMemory() {
            const query = document.getElementById('search-query').value.trim();
            const container = document.getElementById('search-results');

            if (!query) return;

            container.innerHTML = '<div style="text-align:center; color:#64748b;">ğŸ” æ­£åœ¨å…¨å±‹æœç´¢...</div>';

            try {
                const res = await fetch(`${API_BASE}/memories/search_smart?query=${encodeURIComponent(query)}`);
                const data = await res.json();
                const results = data.results;

                if (!results || results.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px;">ğŸ¤·â€â™‚ï¸ æ²¡æ‰¾åˆ°ç›¸å…³ç‰©å“</div>';
                    return;
                }

                let html = '';
                results.forEach(item => {
                    // item ç»“æ„: { item_name: "è‹¹æœ", total_quantity: 9, locations: [...] }

                    // 1. ç‰©å“å¤´éƒ¨ï¼šåå­— + æ€»æ•°
                    html += `
                <div class="result-item">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div style="font-weight:bold; font-size:18px; color:#1e293b;">${item.item_name}</div>
                        <span class="badge badge-qty" style="font-size:13px;">æ€»è®¡: ${item.total_quantity}</span>
                    </div>
            `;

                    // 2. ä½ç½®åˆ†å¸ƒåˆ—è¡¨
                    if (item.locations && item.locations.length > 0) {
                        html += `<div style="background:#f1f5f9; border-radius:8px; padding:8px; font-size:14px;">`;
                        item.locations.forEach(loc => {
                            html += `
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px; border-bottom:1px dashed #cbd5e1; padding-bottom:4px;">
                            <span style="color:#334155;">ğŸ“ ${loc.location}</span>
                            <span style="font-weight:bold; color:#0f766e;">${loc.quantity} ${loc.unit}</span>
                        </div>
                    `;
                        });
                        // å»æ‰æœ€åä¸€ä¸ªå…ƒç´ çš„ border-bottom
                        html = html.replace(/border-bottom:1px dashed #cbd5e1; padding-bottom:4px;"/g, (match, offset, string) => {
                            // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¤„ç†ï¼Œå®é™… CSS :last-child æ›´å¥½ï¼Œä½†è¿™é‡Œç›´æ¥æ”¹å­—ç¬¦ä¸²æœ€å¿«
                            return match;
                        });
                        html += `</div>`;
                    } else {
                        html += `<div style="font-size:12px; color:#94a3b8;">(æš‚æ— å…·ä½“ä½ç½®è®°å½•)</div>`;
                    }

                    html += `</div>`; // end result-item
                });

                container.innerHTML = html;

            } catch (err) {
                console.error(err);
                container.innerHTML = '<div style="color:red; text-align:center;">âŒ æœç´¢å‡ºé”™ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—</div>';
            }
        }


        // 3. åŠ è½½ä½ç½®æ ‘
        async function loadLocationTree() {
            const container = document.getElementById('location-tree');
            try {
                const res = await fetch(`${API_BASE}/locations/tree`);
                const treeData = await res.json();
                container.innerHTML = renderTree(treeData);
            } catch (err) {
                container.innerHTML = "åŠ è½½å¤±è´¥";
            }
        }

        // é€’å½’æ¸²æŸ“æ ‘
        function renderTree(nodes) {
            if (!nodes || nodes.length === 0) return '';
            let html = '<ul>';
            nodes.forEach(node => {
                html += `<li>ğŸ“ ${node.name}`;
                if (node.children && node.children.length > 0) {
                    html += renderTree(node.children);
                }
                html += '</li>';
            });
            html += '</ul>';
            return html;
        }

        // åˆå§‹åŒ–
        loadLocationTree();
    </script>
</body>

</html>